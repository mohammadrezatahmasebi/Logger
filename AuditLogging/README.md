# AuditLogging Library

## Overview

The AuditLogging library provides a simple way to audit HTTP requests and responses in an ASP.NET Core application. It captures detailed information about each request, including:

-   Request and response headers and bodies
-   Status code and duration
-   Outgoing HTTP calls made during the request
-   Entity Framework Core database commands executed during the request (if configured)

The captured audit logs are stored in a MongoDB database. The library also provides an API to retrieve these logs.

## Installation

To install the library, use the .NET CLI:

```bash
dotnet add package Your.AuditLogging.PackageName
```

*(Note: Replace `Your.AuditLogging.PackageName` with the actual package name on NuGet.org.)*

## Configuration

To configure the audit logging in your ASP.NET Core application, you need to modify your `Program.cs` file.

### 1. Configure `appsettings.json`

Add the MongoDB connection settings to your `appsettings.json` file:

```json
{
  "MongoDbSettings": {
    "ConnectionString": "mongodb://localhost:27017",
    "DatabaseName": "AuditDb"
  }
}
```

### 2. Configure Services in `Program.cs`

In your `Program.cs` file, add the following services to the dependency injection container:

```csharp
using AuditLogging;

var builder = WebApplication.CreateBuilder(args);

// ... other services

// 1. Add Audit Logging services
builder.Services.AddAuditLogging(options =>
{
    // options.LogEntityFrameworkCore = true; // Uncomment if you want to log EF Core commands
});

// 2. Configure MongoDB persistence
var mongoDbSettings = builder.Configuration.GetSection("MongoDbSettings").Get<MongoDbSettings>();
builder.Services.AddMongoDbPersistence(mongoDbSettings.ConnectionString, mongoDbSettings.DatabaseName);

// 3. Register the log reader service
builder.Services.AddAuditLogReader();

builder.Services.AddControllers();

// ...
```

### 3. Add Middleware

Add the `AuditMiddleware` and `CorrelationMiddleware` to the request pipeline in `Program.cs`:

```csharp
var app = builder.Build();

// ...

app.UseMiddleware<CorrelationMiddleware>();
app.UseMiddleware<AuditMiddleware>();

// ...

app.Run();
```

## Log Retrieval API

The library provides an API to retrieve the audit logs from the database. The `Logger` example project includes an `AuditLogsController` that exposes the following endpoints:

### Get Logs by Correlation ID

-   **Endpoint:** `GET /audit-logs/{correlationId}`
-   **Description:** Retrieves all audit logs for a specific `correlationId`.
-   **Example:** `GET /audit-logs/0HLLV3S8P8Q4P:00000001`

### Get All Logs Grouped by Correlation ID

-   **Endpoint:** `GET /audit-logs`
-   **Description:** Retrieves all audit logs from the database, grouped by `correlationId`.

## Tracing and Correlation

The library automatically correlates all events within a single request using a `CorrelationId`. This ID is generated by the `CorrelationMiddleware` and is attached to:

-   The main HTTP audit log for the request.
-   All outgoing HTTP calls made during the request.
-   All Serilog log messages created during the request.

This allows you to easily trace all events related to a single user request. The Serilog integration works out of the box, thanks to the `Serilog.Enrichers.Span` package and the OpenTelemetry setup. Any logs you create using the standard `ILogger` will be automatically enriched with the `TraceId` and `SpanId`.
